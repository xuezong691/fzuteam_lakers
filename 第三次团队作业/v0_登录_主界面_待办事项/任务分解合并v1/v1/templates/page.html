<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç³»ç»Ÿä¸»ç•Œé¢</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='todotask.css') }}">
    <!-- å¼•å…¥AIèŠå¤©æ¨¡å—çš„CSSæ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='ai-chat.css') }}">
    <!-- å¼•å…¥ä»»åŠ¡åˆ†è§£æ¨¡å—çš„CSSæ ·å¼ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='task_decomposition.css') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        /* ========== å·¦ä¾§è¾¹æ  ========== */
        .sidebar {
            width: 240px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo-container {
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            width: 36px;
            height: 36px;
            background: #3498db;
            border-radius: 6px;
        }

        .nav-links {
            padding: 20px 0;
            list-style: none;
        }

        .nav-links li {
            padding: 12px 24px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-links li:hover,
        .nav-links li.active {
            background: #34495e;
            color: #3498db;
        }

        .nav-links li i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* ========== ä¸»å†…å®¹åŒº ========== */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 30px;
            background: #ffffff;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .page-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            min-height: 500px;
        }

        /* å“åº”å¼ï¼šå°å±éšè—ä¾§è¾¹æ ï¼ˆå¯é€‰ï¼‰ */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .sidebar .logo span,
            .sidebar .nav-links li span {
                display: none;
            }

            .main-content {
                margin-left: 70px;
            }
        }
    </style>
</head>

<body>

    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">
                <span>ä½ å¥½ï¼å°åŠåŒå­¦</span>
            </div>
        </div>
        <ul class="nav-links" id="navLinks">

            <li data-page="dashboard" class="active">
                <span>ğŸ’¡</span>
                <!-- å°†"AIåŠ©æ‰‹"æ”¹ä¸º"å°åŠåŒå­¦" -->
                <span>å°åŠåŒå­¦</span>
            </li>

            <li data-page="data">
                <span>ğŸ§‘â€ğŸ’¼</span>
                <span>æˆå‘˜æ•°æ®</span>
            </li>

            <li data-page="meeting">
                <span>ğŸ“„</span>
                <span>ä¼šè®®åŠ©æ‰‹</span>
            </li>

            <li data-page="task_generater">
                <span>ğŸ§©</span>
                <span>æ™ºèƒ½ä»»åŠ¡åˆ†è§£</span>
            </li>

            <li data-page="todotask">
                <span>ğŸ“</span>
                <span>äº‹é¡¹çœ‹æ¿</span>
            </li>

        </ul>
    </div>

    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="main-content">
        <!-- AIèŠå¤©æ¨¡å— - æ·»åŠ å®Œæ•´çš„å¯¹è¯ç•Œé¢ -->
        <div class="page active" id="page-dashboard">
            <h2>ğŸ’¡ æ¥å’Œå¤§æ¨¡å‹èŠå¤©</h2>
            <div class="page-content">
                <div class="ai-chat-container">
                    <div class="ai-chat-header">
                        <h3>å°åŠåŒå­¦</h3>
                        <button type="button" id="clearChatBtn" class="ai-chat-clear-btn">æ¸…ç©ºè®°å½•</button>
                    </div>
                    <div id="chatMessages" class="ai-chat-messages"></div>
                    <form id="chatForm" class="ai-chat-input-area">
                        <input type="text" id="chatInput" class="ai-chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                            autocomplete="off" required />
                        <button type="submit" class="ai-chat-send-btn">å‘é€</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- å›¢é˜Ÿæˆå‘˜ -->
        <div class="page" id="page-data">
            <h2>ğŸ§‘â€ğŸ’¼ å›¢é˜Ÿæˆå‘˜æ•°æ®</h2>
            <div class="page-content">
                <p>åœ¨æ­¤æ¨¡å—è¿›è¡Œæ•°æ®å¯¼å…¥ã€æ¸…æ´—ä¸å¯è§†åŒ–åˆ†æã€‚</p>
                <button style="margin-top: 10px;">ä¸Šä¼ æ•°æ®æ–‡ä»¶</button>
            </div>
        </div>

        <!-- ä¼šè®®åŠ©æ‰‹ -->
        <div class="page" id="page-meeting">
            <h2>ğŸ“„ ä¼šè®®è¯­è¨€è½¬æ–‡å­—ã€è¯­è¨€ä¸€é”®ç”Ÿæˆæ‘˜è¦</h2>
            <div class="page-content">
                <p>è‡ªåŠ¨ç”Ÿæˆå‘¨æŠ¥ã€æœˆæŠ¥æˆ–è‡ªå®šä¹‰æŠ¥å‘Šã€‚</p>
                <select style="margin-top: 10px; padding: 5px;">
                    <option>é€‰æ‹©æŠ¥å‘Šç±»å‹</option>
                    <option>å‘¨æŠ¥</option>
                    <option>æœˆæŠ¥</option>
                </select>
            </div>
        </div>

        <!-- æ™ºèƒ½ä»»åŠ¡åˆ†è§£ -->
<div class="page" id="page-task_generater">
    <h2>ğŸ§© æ™ºèƒ½ä»»åŠ¡åˆ†è§£</h2>
    <div class="page-content">
        <div class="task-decomposition-container">
            <!-- ä»»åŠ¡è¾“å…¥è¡¨å• -->
            <div class="input-section">
                <h3>ä»»åŠ¡ä¿¡æ¯è¾“å…¥</h3>
                <form id="taskInputForm" class="task-form">
                    <div class="form-group">
                        <label for="taskType">ä»»åŠ¡ç±»å‹ *</label>
                        <select id="taskType" required>
                            <option value="">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</option>
                            <option value="software">è½¯ä»¶å¼€å‘</option>
                            <option value="ppt">PPTåˆ¶ä½œ</option>
                            <option value="research">ç ”ç©¶é¡¹ç›®</option>
                            <option value="study">å­¦ä¹ ä»»åŠ¡</option>
                            <option value="management">é¡¹ç›®ç®¡ç†</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="background">é¡¹ç›®èƒŒæ™¯å’ŒåŠ¨æœº *</label>
                        <textarea id="background" rows="3" required placeholder="è¯·è¾“å…¥é¡¹ç›®èƒŒæ™¯ã€ç›®æ ‡å’ŒåŠ¨æœº..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="finalDeliverable">æœ€ç»ˆäº¤ä»˜æˆæœ *</label>
                        <textarea id="finalDeliverable" rows="3" required placeholder="è¯·è¾“å…¥æœ€ç»ˆè¦äº¤ä»˜çš„å…·ä½“æˆæœï¼Œå¦‚PPTã€æŠ¥å‘Šã€è½¯ä»¶ç­‰..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="timeLimit">é™å®šæ—¶é•¿ï¼ˆå¤©ï¼‰ *</label>
                        <input type="number" id="timeLimit" required min="1" max="365"
                               placeholder="è¯·è¾“å…¥ä»»åŠ¡é™å®šçš„å¤©æ•°">
                        <small class="date-hint">è¯·è¾“å…¥ä»»åŠ¡éœ€è¦åœ¨å¤šå°‘å¤©å†…å®Œæˆ</small>
                    </div>

                    <div class="form-group">
                        <label>è´¨é‡è¦æ±‚</label>
                        <div class="criteria-section">
                            <div class="criteria-group">
                                <label>å¿…é¡»æ»¡è¶³çš„è¦æ±‚</label>
                                <div id="mustHaveContainer" class="criteria-items">
                                    <div class="criteria-item">
                                        <input type="text" class="criteria-input" placeholder="ä¾‹å¦‚ï¼šå¿…é¡»ä½¿ç”¨Pythonå¼€å‘">
                                        <button type="button" class="add-criteria" onclick="addCriteria('mustHave')">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="criteria-group">
                                <label>å¯é€‰ä¼˜åŒ–</label>
                                <div id="niceToHaveContainer" class="criteria-items">
                                    <div class="criteria-item">
                                        <input type="text" class="criteria-input" placeholder="ä¾‹å¦‚ï¼šæ”¯æŒç§»åŠ¨ç«¯è®¿é—®">
                                        <button type="button" class="add-criteria" onclick="addCriteria('niceToHave')">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>çº¦æŸæ¡ä»¶</label>
                        <div class="constraints-section">
                            <div class="constraint-group">
                                <label>ç¦æ­¢äº‹é¡¹</label>
                                <div id="forbiddenContainer" class="constraint-items">
                                    <div class="constraint-item">
                                        <input type="text" class="constraint-input" placeholder="ä¾‹å¦‚ï¼šä¸èƒ½ä½¿ç”¨ä»˜è´¹è½¯ä»¶">
                                        <button type="button" class="add-constraint" onclick="addConstraint('forbidden')">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="constraint-group">
                                <label>å‰æå‡è®¾</label>
                                <div id="assumptionsContainer" class="constraint-items">
                                    <div class="constraint-item">
                                        <input type="text" class="constraint-input" placeholder="ä¾‹å¦‚ï¼šå‡è®¾å›¢é˜Ÿæˆå‘˜éƒ½ä¼šPython">
                                        <button type="button" class="add-constraint" onclick="addConstraint('assumptions')">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="generateTaskBtn" class="btn btn-primary">ç”Ÿæˆä»»åŠ¡åˆ†è§£</button>
                    </div>
                </form>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="result-section">
                <h3>ä»»åŠ¡åˆ†è§£ç»“æœ</h3>
                <div id="taskResult" class="task-result" style="display: none;">
                    <div class="result-header">
                        <h4>AIç”Ÿæˆçš„ä»»åŠ¡åˆ—è¡¨</h4>
                        <button type="button" id="matchTaskBtn" class="btn btn-secondary">æ™ºèƒ½æˆå‘˜åŒ¹é…</button>
                    </div>
                    <div id="taskCards" class="task-cards">
                        <!-- ä»»åŠ¡å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div id="matchResult" class="match-result" style="display: none;">
                    <h4>æˆå‘˜åŒ¹é…ç»“æœ</h4>
                    <div id="matchCards" class="match-cards">
                        <!-- åŒ¹é…ç»“æœå¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- äº‹é¡¹çœ‹æ¿ -->
        <div class="page" id="page-todotask">
            <h2>ğŸ“ äº‹é¡¹çœ‹æ¿</h2>
            <div class="page-content">
                <div class="todo-wrapper">
                    <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + åˆ·æ–°æŒ‰é’® -->
                    <div class="todo-header">
                        <div>
                            <h3>å›¢é˜Ÿå¾…åŠäº‹é¡¹</h3>
                            <p class="todo-subtitle">æ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·åŠ è½½ä»»åŠ¡</p>
                        </div>
                        <div class="todo-actions">
                            <button type="button" id="btnRefreshTasks" class="btn-secondary">
                                åˆ·æ–°ä»»åŠ¡
                            </button>
                        </div>
                    </div>

                    <!-- æ·»åŠ ä»»åŠ¡è¡¨å• -->
                    <form id="taskForm" class="task-form">
                        <div class="task-form-row">
                            <div class="task-form-field">
                                <label for="taskTime">æ—¥æœŸ</label>
                                <input type="date" id="taskTime" name="time" required />
                            </div>
                            <div class="task-form-field">
                                <label for="taskPlace">åœ°ç‚¹</label>
                                <input type="text" id="taskPlace" name="place" placeholder="ä¾‹å¦‚ï¼šå®éªŒå®¤A" />
                            </div>
                        </div>

                        <div class="task-form-row">
                            <div class="task-form-field">
                                <label for="taskStaff">è´Ÿè´£äºº</label>
                                <input type="text" id="taskStaff" name="staff" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" />
                            </div>
                            <div class="task-form-field">
                                <label for="taskUrgency">ç´§æ€¥ç¨‹åº¦</label>
                                <select id="taskUrgency" name="urgency">
                                    <option value="1">ä¸€èˆ¬</option>
                                    <option value="2">é‡è¦</option>
                                    <option value="3">ç´§æ€¥</option>
                                </select>
                            </div>
                        </div>

                        <div class="task-form-row">
                            <div class="task-form-field full">
                                <label for="taskSomething">ä»»åŠ¡å†…å®¹</label>
                                <textarea id="taskSomething" name="something" rows="2" placeholder="éœ€è¦å®Œæˆçš„äº‹é¡¹..."
                                    required></textarea>
                            </div>
                        </div>

                        <div class="task-form-actions">
                            <button type="submit" class="btn-primary">
                                æ·»åŠ ä»»åŠ¡
                            </button>
                        </div>
                    </form>

                    <!-- ä»»åŠ¡å¡ç‰‡å®¹å™¨ -->
                    <div id="taskBoard" class="task-board">
                        <p class="task-empty">
                            ç›®å‰è¿˜æ²¡æœ‰ä»»åŠ¡,ç‚¹å‡»ä¸Šæ–¹"åˆ·æ–°ä»»åŠ¡"ä»åç«¯åŠ è½½æ•°æ®ï¼Œæˆ–è€…å…ˆæ·»åŠ ä¸€æ¡ä»»åŠ¡ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- å¼•å…¥axioså’ŒAIèŠå¤©æ¨¡å—çš„JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- å¼•å…¥æ™ºèƒ½ä»»åŠ¡åˆ†è§£JS -->
    <script src="{{ url_for('static', filename='task_decomposition.js') }}"></script>
    <script>
        // AIèŠå¤©æ¨¡å—
        ; (() => {
            const STORAGE_KEY = "ai_chat_history"
            const axios = window.axios
            const WELCOME_MESSAGE =
                "ä½ å¥½!æˆ‘æ˜¯å°åŠåŒå­¦ï¼Œæ˜¯ä½ ä»¬çš„ä¸“å±æ™ºèƒ½ä½“åŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥å¸®ä½ ä¿®æ”¹å¾…åŠäº‹é¡¹ï¼Œä¹Ÿå¯ä»¥å’Œä½ èŠå¤©ï¼Œè¯·é—®æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åˆ°ä½ çš„å—?"

            // è·å–èŠå¤©å†å²
            function getChatHistory() {
                const history = localStorage.getItem(STORAGE_KEY)
                return history ? JSON.parse(history) : []
            }

            // ä¿å­˜èŠå¤©å†å²
            function saveChatHistory(history) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history))
            }

            // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
            function renderMessages() {
                const chatMessages = document.getElementById("chatMessages")
                if (!chatMessages) return

                const history = getChatHistory()
                chatMessages.innerHTML = ""

                history.forEach((msg) => {
                    const messageDiv = document.createElement("div")
                    messageDiv.className = "ai-chat-message " + msg.role

                    const avatarDiv = document.createElement("div")
                    avatarDiv.className = "ai-chat-avatar"
                    avatarDiv.textContent = msg.role === "user" ? "ğŸ‘¤" : "ğŸ¤–"

                    const bubbleDiv = document.createElement("div")
                    bubbleDiv.className = "ai-chat-bubble"
                    bubbleDiv.textContent = msg.content

                    messageDiv.appendChild(avatarDiv)
                    messageDiv.appendChild(bubbleDiv)
                    chatMessages.appendChild(messageDiv)
                })

                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°å†å²
            function addMessage(role, content) {
                const history = getChatHistory()
                history.push({ role: role, content: content })
                saveChatHistory(history)
                renderMessages()
            }

            // å‘é€æ¶ˆæ¯åˆ°AI
            async function sendMessage(message) {
                if (!message.trim()) return

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                addMessage("user", message)

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const chatMessages = document.getElementById("chatMessages")
                const loadingDiv = document.createElement("div")
                loadingDiv.className = "ai-chat-message assistant"
                loadingDiv.innerHTML = `
      <div class="ai-chat-avatar">ğŸ¤–</div>
      <div class="ai-chat-bubble">æ­£åœ¨æ€è€ƒ...</div>
    `
                loadingDiv.id = "loadingMessage"
                chatMessages.appendChild(loadingDiv)
                chatMessages.scrollTop = chatMessages.scrollHeight

                try {
                    const response = await axios.post("/api/ai/chat", {
                        query: message,
                        paragraph: "",
                    })

                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    const loading = document.getElementById("loadingMessage")
                    if (loading) loading.remove()

                    if (response.data.success) {
                        addMessage("assistant", response.data.response)
                    } else {
                        addMessage("assistant", "æŠ±æ­‰ï¼Œå‡ºç°äº†é”™è¯¯ï¼š" + (response.data.message || "æœªçŸ¥é”™è¯¯"))
                    }
                } catch (error) {
                    // ç§»é™¤åŠ è½½çŠ¶æ€
                    const loading = document.getElementById("loadingMessage")
                    if (loading) loading.remove()

                    console.error("å‘é€æ¶ˆæ¯å¤±è´¥:", error)
                    let errorMsg = "æŠ±æ­‰ï¼Œç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"
                    if (error.response) {
                        errorMsg += `\nçŠ¶æ€ç : ${error.response.status}`
                        if (error.response.data && error.response.data.message) {
                            errorMsg += `\né”™è¯¯: ${error.response.data.message}`
                        }
                    } else if (error.request) {
                        errorMsg += "\næ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œã€‚"
                    } else {
                        errorMsg += `\n${error.message}`
                    }
                    addMessage("assistant", errorMsg)
                }
            }

            // æ¸…ç©ºèŠå¤©å†å²
            function clearHistory() {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY)
                    initWelcomeMessage()
                    renderMessages()
                }
            }

            function initWelcomeMessage() {
                const history = getChatHistory()
                if (history.length === 0) {
                    saveChatHistory([{ role: "assistant", content: WELCOME_MESSAGE }])
                }
            }

            // åˆå§‹åŒ–èŠå¤©ç•Œé¢
            function initAIChat() {
                const chatForm = document.getElementById("chatForm")
                const chatInput = document.getElementById("chatInput")
                const clearBtn = document.getElementById("clearChatBtn")

                if (!chatForm || !chatInput) {
                    console.error("Chat form elements not found!")
                    return
                }

                initWelcomeMessage()
                // åŠ è½½å†å²æ¶ˆæ¯
                renderMessages()

                // è¡¨å•æäº¤äº‹ä»¶
                chatForm.addEventListener("submit", (e) => {
                    e.preventDefault()
                    const message = chatInput.value.trim()
                    if (message) {
                        sendMessage(message)
                        chatInput.value = ""
                    }
                })

                // æ¸…ç©ºå†å²æŒ‰é’®
                if (clearBtn) {
                    clearBtn.addEventListener("click", clearHistory)
                }
            }

            // å¯¼å‡ºåˆ°å…¨å±€
            window.AIChat = {
                init: initAIChat,
                send: sendMessage,
                clear: clearHistory,
            }
        })()

    </script>

    <script>
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ userIdï¼ˆç™»å½•æ—¶å†™å…¥ localStorageï¼‰
        function getCurrentUserId() {
            return localStorage.getItem("userId");
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä¸ºå¡ç‰‡
        function renderTasks(tasks) {
            var board = document.getElementById("taskBoard");
            if (!board) return;

            board.innerHTML = "";

            if (!tasks || tasks.length === 0) {
                var empty = document.createElement("p");
                empty.className = "task-empty";
                empty.textContent = "æ²¡æœ‰ä»»åŠ¡ï¼Œè¯•è¯•æ·»åŠ ä¸€æ¡æˆ–ç‚¹å‡»\"åˆ·æ–°ä»»åŠ¡\"ã€‚";
                board.appendChild(empty);
                return;
            }

            tasks.forEach(function (task) {
                var card = document.createElement("div");
                card.className = "task-card";

                var title = document.createElement("div");
                title.className = "task-title";
                title.textContent = task.something || "æœªå¡«å†™ä»»åŠ¡å†…å®¹";

                var meta = document.createElement("div");
                meta.className = "task-meta";

                var timeSpan = document.createElement("span");
                timeSpan.textContent = "æ—¥æœŸï¼š" + (task.time || "-");

                var placeSpan = document.createElement("span");
                placeSpan.textContent = "åœ°ç‚¹ï¼š" + (task.place || "-");

                var staffSpan = document.createElement("span");
                staffSpan.textContent = "è´Ÿè´£äººï¼š" + (task.staff || "-");

                meta.appendChild(timeSpan);
                meta.appendChild(placeSpan);
                meta.appendChild(staffSpan);

                var content = document.createElement("div");
                content.className = "task-content";
                content.textContent = task.something || "";

                var footer = document.createElement("div");
                footer.className = "task-footer";

                var urgencySpan = document.createElement("span");
                urgencySpan.className = "task-urgency";
                urgencySpan.textContent = "ç´§æ€¥ç¨‹åº¦ï¼š" + (task.urgency || 1);

                var deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "task-delete-btn";
                deleteBtn.textContent = "åˆ é™¤";
                deleteBtn.setAttribute("data-id", task.id);

                footer.appendChild(urgencySpan);
                footer.appendChild(deleteBtn);

                card.appendChild(title);
                card.appendChild(meta);
                // card.appendChild(content);
                card.appendChild(footer);

                board.appendChild(card);
            });
        }

        // è°ƒç”¨ /api/task/refresh è·å–ä»»åŠ¡åˆ—è¡¨
        async function refreshTasks() {
            var userId = getCurrentUserId();
            if (!userId) {
                alert("æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚");
                return;
            }

            try {
                var response = await fetch("/api/task/refresh", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId, 10)
                    })
                });

                if (!response.ok) {
                    throw new Error("ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
                }

                var result = await response.json();
                if (result.success) {
                    renderTasks(result.tasks || []);
                } else {
                    alert(result.message || "åˆ·æ–°ä»»åŠ¡å¤±è´¥");
                }
            } catch (err) {
                console.error(err);
                alert("åˆ·æ–°ä»»åŠ¡å¤±è´¥ï¼š" + err.message);
            }
        }

        // è°ƒç”¨ /api/task/add æ·»åŠ ä»»åŠ¡
        async function handleAddTask(event) {
            event.preventDefault();

            var userId = getCurrentUserId();
            if (!userId) {
                alert("æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚");
                return;
            }

            var timeInput = document.getElementById("taskTime");
            var placeInput = document.getElementById("taskPlace");
            var staffInput = document.getElementById("taskStaff");
            var urgencySelect = document.getElementById("taskUrgency");
            var somethingInput = document.getElementById("taskSomething");

            var payload = {
                user_id: parseInt(userId, 10),
                time: timeInput.value,
                place: placeInput.value,
                staff: staffInput.value,
                something: somethingInput.value,
                urgency: parseInt(urgencySelect.value || "1", 10)
            };

            if (!payload.time || !payload.something) {
                alert("æ—¥æœŸå’Œä»»åŠ¡å†…å®¹ä¸ºå¿…å¡«é¡¹ã€‚");
                return;
            }

            try {
                var response = await fetch("/api/task/add", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error("ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
                }

                var result = await response.json();
                if (result.success) {
                    // æ¸…ç©ºè¡¨å•
                    placeInput.value = "";
                    staffInput.value = "";
                    somethingInput.value = "";
                    urgencySelect.value = "1";
                    // é‡æ–°åˆ·æ–°åˆ—è¡¨
                    await refreshTasks();
                } else {
                    alert(result.message || "æ·»åŠ ä»»åŠ¡å¤±è´¥");
                }
            } catch (err) {
                console.error(err);
                alert("æ·»åŠ ä»»åŠ¡å¤±è´¥ï¼š" + err.message);
            }
        }

        // è°ƒç”¨ /api/task/delete åˆ é™¤ä»»åŠ¡
        async function deleteTaskById(id) {
            if (!id) return;
            if (!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡ä»»åŠ¡å—ï¼Ÿ")) return;

            try {
                var response = await fetch("/api/task/delete", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ id: id })
                });

                if (!response.ok) {
                    throw new Error("ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
                }

                var result = await response.json();
                if (result.success) {
                    await refreshTasks();
                } else {
                    alert(result.message || "åˆ é™¤ä»»åŠ¡å¤±è´¥");
                }
            } catch (err) {
                console.error(err);
                alert("åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼š" + err.message);
            }
        }

        // äº‹é¡¹çœ‹æ¿å†…äº‹ä»¶ç»‘å®šï¼ˆæŒ‰é’®ã€å¡ç‰‡åˆ é™¤ï¼‰
        function initTodoTaskEvents() {
            var refreshBtn = document.getElementById("btnRefreshTasks");
            if (refreshBtn) {
                refreshBtn.addEventListener("click", function () {
                    refreshTasks();
                });
            }

            var taskForm = document.getElementById("taskForm");
            if (taskForm) {
                taskForm.addEventListener("submit", handleAddTask);
            }

            var taskBoard = document.getElementById("taskBoard");
            if (taskBoard) {
                taskBoard.addEventListener("click", function (event) {
                    var target = event.target;
                    if (target.classList.contains("task-delete-btn")) {
                        var id = target.getAttribute("data-id");
                        deleteTaskById(id);
                    }
                });
            }
        }

        // ========== å·¦ä¾§å¯¼èˆªï¼šé¡µé¢åˆ‡æ¢é€»è¾‘ ==========
        document.querySelectorAll(".nav-links li").forEach(function (item) {
            item.addEventListener("click", function () {
                var pageId = this.getAttribute("data-page");

                // ç§»é™¤æ‰€æœ‰ active
                document
                    .querySelectorAll(".nav-links li")
                    .forEach(function (li) {
                        li.classList.remove("active");
                    });
                document
                    .querySelectorAll(".page")
                    .forEach(function (p) {
                        p.classList.remove("active");
                    });

                // æ¿€æ´»å½“å‰é¡¹
                this.classList.add("active");
                var pageElement = document.getElementById("page-" + pageId);
                if (pageElement) {
                    pageElement.classList.add("active");
                }

                // å¦‚æœåˆ‡æ¢åˆ°äº‹é¡¹çœ‹æ¿ï¼Œè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
                if (pageId === "todotask") {
                    refreshTasks();
                }
            });
        });

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem("userId");
            localStorage.removeItem("teamName");
            window.location.href = "/"; // è·³å›ç™»å½•é¡µ
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äº"ä¸ªäººä¸­å¿ƒ"ï¼‰
        window.addEventListener("DOMContentLoaded", function () {
            var userId = localStorage.getItem("userId");
            var teamName = localStorage.getItem("teamName");

            // å¦‚æœä½ é¡µé¢é‡ŒçœŸçš„æœ‰å¯¹åº”å…ƒç´ ï¼Œå¯ä»¥è§£å¼€ä¸‹é¢çš„æ³¨é‡Šæ¥æ˜¾ç¤º
            // var userIdSpan = document.getElementById("displayUserId");
            // var teamNameSpan = document.getElementById("displayTeamName");

            if (userId && teamName) {
                // if (userIdSpan) userIdSpan.textContent = userId;
                // if (teamNameSpan) teamNameSpan.textContent = teamName;
            } else {
                // æœªç™»å½•åˆ™è·³è½¬å›é¦–é¡µ
                window.location.href = "/";
            }

            // åˆå§‹åŒ–äº‹é¡¹çœ‹æ¿çš„äº‹ä»¶ï¼ˆæŒ‰é’®ã€è¡¨å•ã€å¡ç‰‡åˆ é™¤ï¼‰
            initTodoTaskEvents();

            if (window.AIChat) {
                window.AIChat.init();
            }
           
	    // åˆå§‹åŒ–æ™ºèƒ½ä»»åŠ¡åˆ†è§£
            if (window.TaskDecomposition) {
                window.TaskDecomposition.init();
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°æ™ºèƒ½ä»»åŠ¡åˆ†è§£é¡µé¢ï¼Œå¯ä»¥æ‰§è¡Œç‰¹å®šåˆå§‹åŒ–
            document.querySelectorAll(".nav-links li").forEach(function(item) {
                item.addEventListener("click", function() {
                    var pageId = this.getAttribute("data-page");
                    if (pageId === "task_generater") {
                        // åˆ‡æ¢åˆ°ä»»åŠ¡åˆ†è§£é¡µé¢æ—¶çš„é€»è¾‘
                        console.log("åˆ‡æ¢åˆ°æ™ºèƒ½ä»»åŠ¡åˆ†è§£é¡µé¢");
                    }
                });
            });
        });
    

    </script>


</body>

</html>