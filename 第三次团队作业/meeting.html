<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç³»ç»Ÿä¸»ç•Œé¢</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='todotask.css') }}">
  <!-- å¼•å…¥ä¼šè®®æ¨¡å—ä¸“å±CSSï¼ˆæ”¾åœ¨staticæ–‡ä»¶å¤¹ï¼‰ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='meeting.css') }}">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
    }
    body {
      display: flex;
      min-height: 100vh;
      background-color: #f8f9fa;
    }
    /* ========== å·¦ä¾§è¾¹æ  ========== */
    .sidebar {
      width: 240px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .logo-container {
      padding: 20px;
      border-bottom: 1px solid #34495e;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img {
      width: 36px;
      height: 36px;
      background: #3498db;
      border-radius: 6px;
    }
    .nav-links {
      padding: 20px 0;
      list-style: none;
    }
    .nav-links li {
      padding: 12px 24px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-links li:hover,
    .nav-links li.active {
      background: #34495e;
      color: #3498db;
    }
    .nav-links li i {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    /* ========== ä¸»å†…å®¹åŒº ========== */
    .main-content {
      flex: 1;
      margin-left: 240px;
      padding: 30px;
      background: #ffffff;
    }
    .page {
      display: none;
      animation: fadeIn 0.4s ease-in-out;
    }
    .page.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .page-content {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      min-height: 500px;
    }
    /* å“åº”å¼ï¼šå°å±éšè—ä¾§è¾¹æ ï¼ˆå¯é€‰ï¼‰ */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }
      .sidebar .logo span,
      .sidebar .nav-links li span {
        display: none;
      }
      .main-content {
        margin-left: 70px;
      }
    }
  </style>
</head>
<body>
  <!-- å·¦ä¾§å¯¼èˆªæ  -->
  <div class="sidebar">
    <div class="logo-container">
      <div class="logo">
        <span>ä½ å¥½ï¼å°åŠåŒå­¦</span>
      </div>
    </div>
    <ul class="nav-links" id="navLinks">
      <li data-page="dashboard" class="active">
        <span>ğŸ’¡</span>
        <span>AIåŠ©æ‰‹</span>
      </li>
      <li data-page="data">
        <span>ğŸ§‘â€ğŸ’¼</span>
        <span>æˆå‘˜æ•°æ®</span>
      </li>
      <li data-page="meeting">
        <span>ğŸ“„</span>
        <span>ä¼šè®®åŠ©æ‰‹</span>
      </li>
      <li data-page="task_generater">
        <span>ğŸ§©</span>
        <span>æ™ºèƒ½ä»»åŠ¡åˆ†è§£</span>
      </li>
      <li data-page="todotask">
        <span>ğŸ“</span>
        <span>äº‹é¡¹çœ‹æ¿</span>
      </li>
    </ul>
  </div>
  <!-- å³ä¾§å†…å®¹åŒº -->
  <div class="main-content">
    <!-- AIèŠå¤© -->
    <div class="page active" id="page-dashboard">
      <h2>ğŸ’¡ æ¥å’Œå¤§æ¨¡å‹èŠå¤©</h2>
      <div class="page-content">
        <p>æ¬¢è¿ä½¿ç”¨ç³»ç»Ÿï¼è¿™é‡Œæ˜¯ä¸»æ§åˆ¶é¢æ¿ã€‚</p>
        <p>ä½ å¯ä»¥æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€ä»»åŠ¡è¿›åº¦ç­‰å…³é”®ä¿¡æ¯ã€‚</p>
      </div>
    </div>
    <!-- å›¢é˜Ÿæˆå‘˜ -->
    <div class="page" id="page-data">
      <h2>ğŸ§‘â€ğŸ’¼ å›¢é˜Ÿæˆå‘˜æ•°æ®</h2>
      <div class="page-content">
        <p>åœ¨æ­¤æ¨¡å—è¿›è¡Œæ•°æ®å¯¼å…¥ã€æ¸…æ´—ä¸å¯è§†åŒ–åˆ†æã€‚</p>
        <button style="margin-top: 10px;">ä¸Šä¼ æ•°æ®æ–‡ä»¶</button>
      </div>
    </div>
    <!-- ä¼šè®®åŠ©æ‰‹ï¼ˆæ–°å¢å®Œæ•´å‰ç«¯å®ç°ï¼‰ -->
    <div class="page" id="page-meeting">
      <h2>ğŸ“„ ä¼šè®®è¯­è¨€è½¬æ–‡å­—ã€è¯­è¨€ä¸€é”®ç”Ÿæˆæ‘˜è¦</h2>
      <div class="page-content">
        <div class="meeting-wrapper">
          <!-- é¡¶éƒ¨æ“ä½œåŒº -->
          <div class="meeting-header">
            <div>
              <h3>ä¼šè®®æ™ºèƒ½å¤„ç†ä¸­å¿ƒ</h3>
              <p class="meeting-subtitle">æ”¯æŒéŸ³é¢‘è½¬æ–‡å­—ã€ä¼šè®®æ‘˜è¦ç”Ÿæˆï¼Œå¿«é€Ÿå¯¼å‡ºæŠ¥å‘Š</p>
            </div>
            <div class="meeting-actions">
              <button type="button" id="btnClearMeeting" class="btn-secondary">
                æ¸…ç©ºå†…å®¹
              </button>
            </div>
          </div>

          <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
          <div class="meeting-tabs">
            <button class="meeting-tab active" data-tab="audio-to-text">éŸ³é¢‘è½¬æ–‡å­—</button>
            <button class="meeting-tab" data-tab="generate-summary">ç”Ÿæˆä¼šè®®æ‘˜è¦</button>
          </div>

          <!-- éŸ³é¢‘è½¬æ–‡å­—é¢æ¿ -->
          <div class="meeting-panel active" id="panel-audio-to-text">
            <div class="meeting-form">
              <div class="meeting-form-field">
                <label for="meetingAudio">ä¸Šä¼ ä¼šè®®éŸ³é¢‘æ–‡ä»¶</label>
                <input type="file" id="meetingAudio" accept="audio/*" />
                <p class="form-hint">æ”¯æŒæ ¼å¼ï¼šmp3ã€wavã€m4aï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡200MB</p>
              </div>
              <div class="meeting-form-field full">
                <label for="audioLanguage">éŸ³é¢‘è¯­è¨€</label>
                <select id="audioLanguage" name="language">
                  <option value="zh-CN">ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰</option>
                  <option value="en-US">è‹±æ–‡ï¼ˆç¾å¼ï¼‰</option>
                  <option value="ja-JP">æ—¥è¯­</option>
                  <option value="ko-KR">éŸ©è¯­</option>
                </select>
              </div>
              <div class="meeting-form-actions">
                <button type="button" id="btnAudioToText" class="btn-primary">
                  å¼€å§‹è½¬å†™
                </button>
              </div>
            </div>

            <!-- è½¬å†™ç»“æœå±•ç¤º -->
            <div class="meeting-result">
              <h4>è½¬å†™ç»“æœ</h4>
              <div class="result-container">
                <textarea id="transcriptBox" rows="10" placeholder="è½¬å†™ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
              </div>
              <div class="result-actions">
                <button type="button" id="btnCopyTranscript" class="btn-secondary">
                  å¤åˆ¶æ–‡æœ¬
                </button>
                <button type="button" id="btnDownloadTranscript" class="btn-secondary">
                  ä¸‹è½½æ–‡æœ¬
                </button>
              </div>
            </div>
          </div>

          <!-- ç”Ÿæˆä¼šè®®æ‘˜è¦é¢æ¿ -->
          <div class="meeting-panel" id="panel-generate-summary">
            <div class="meeting-form">
              <div class="meeting-form-field full">
                <label for="summarySource">è¾“å…¥ä¼šè®®æ–‡æœ¬ï¼ˆæˆ–ç²˜è´´è½¬å†™ç»“æœï¼‰</label>
                <textarea id="summarySource" rows="8" placeholder="è¯·è¾“å…¥ä¼šè®®åŸå§‹æ–‡æœ¬..."></textarea>
              </div>
              <div class="meeting-form-row">
                <div class="meeting-form-field">
                  <label for="summaryType">æŠ¥å‘Šç±»å‹</label>
                  <select id="summaryType" name="summaryType">
                    <option value="å‘¨æŠ¥">å‘¨æŠ¥</option>
                    <option value="æœˆæŠ¥">æœˆæŠ¥</option>
                    <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                  </select>
                </div>
                <div class="meeting-form-field">
                  <label for="summaryLength">æ‘˜è¦é•¿åº¦</label>
                  <select id="summaryLength" name="summaryLength">
                    <option value="short">ç®€çŸ­ï¼ˆ100å­—å†…ï¼‰</option>
                    <option value="medium" selected>ä¸­ç­‰ï¼ˆ300å­—å·¦å³ï¼‰</option>
                    <option value="detailed">è¯¦ç»†ï¼ˆ500å­—ä»¥ä¸Šï¼‰</option>
                  </select>
                </div>
              </div>
              <div class="meeting-form-actions">
                <button type="button" id="btnGenerateSummary" class="btn-primary">
                  ç”Ÿæˆæ‘˜è¦
                </button>
              </div>
            </div>

            <!-- æ‘˜è¦ç»“æœå±•ç¤º -->
            <div class="meeting-result">
              <h4>ä¼šè®®æ‘˜è¦</h4>
              <div class="result-container">
                <textarea id="summaryBox" rows="10" placeholder="ä¼šè®®æ‘˜è¦å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
              </div>
              <div class="result-actions">
                <button type="button" id="btnCopySummary" class="btn-secondary">
                  å¤åˆ¶æ‘˜è¦
                </button>
                <button type="button" id="btnDownloadSummary" class="btn-secondary">
                  ä¸‹è½½æŠ¥å‘Š
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- æ™ºèƒ½ä»»åŠ¡åˆ†è§£ -->
    <div class="page" id="page-task_generater">
      <h2>ğŸ§© æ™ºèƒ½ä»»åŠ¡åˆ†è§£</h2>
      <div class="page-content">
        <p>é…ç½®ç³»ç»Ÿå‚æ•°ã€æƒé™ç®¡ç†ã€é€šçŸ¥è®¾ç½®ç­‰ã€‚</p>
        <label><input type="checkbox"> å¯ç”¨é‚®ä»¶é€šçŸ¥</label>
      </div>
    </div>
    <!-- äº‹é¡¹çœ‹æ¿ -->
    <div class="page" id="page-todotask">
      <h2>ğŸ“ äº‹é¡¹çœ‹æ¿</h2>
      <div class="page-content">
        <div class="todo-wrapper">
          <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + åˆ·æ–°æŒ‰é’® -->
          <div class="todo-header">
            <div>
              <h3>å›¢é˜Ÿå¾…åŠäº‹é¡¹</h3>
              <p class="todo-subtitle">æ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·åŠ è½½ä»»åŠ¡</p>
            </div>
            <div class="todo-actions">
              <button type="button" id="btnRefreshTasks" class="btn-secondary">
                åˆ·æ–°ä»»åŠ¡
              </button>
            </div>
          </div>
          <!-- æ·»åŠ ä»»åŠ¡è¡¨å• -->
          <form id="taskForm" class="task-form">
            <div class="task-form-row">
              <div class="task-form-field">
                <label for="taskTime">æ—¥æœŸ</label>
                <input type="date" id="taskTime" name="time" required />
              </div>
              <div class="task-form-field">
                <label for="taskPlace">åœ°ç‚¹</label>
                <input
                  type="text"
                  id="taskPlace"
                  name="place"
                  placeholder="ä¾‹å¦‚ï¼šå®éªŒå®¤A"
                />
              </div>
            </div>
            <div class="task-form-row">
              <div class="task-form-field">
                <label for="taskStaff">è´Ÿè´£äºº</label>
                <input
                  type="text"
                  id="taskStaff"
                  name="staff"
                  placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰"
                />
              </div>
              <div class="task-form-field">
                <label for="taskUrgency">ç´§æ€¥ç¨‹åº¦</label>
                <select id="taskUrgency" name="urgency">
                  <option value="1">ä¸€èˆ¬</option>
                  <option value="2">é‡è¦</option>
                  <option value="3">ç´§æ€¥</option>
                </select>
              </div>
            </div>
            <div class="task-form-row">
              <div class="task-form-field full">
                <label for="taskSomething">ä»»åŠ¡å†…å®¹</label>
                <textarea
                  id="taskSomething"
                  name="something"
                  rows="2"
                  placeholder="éœ€è¦å®Œæˆçš„äº‹é¡¹..."
                  required
                ></textarea>
              </div>
            </div>
            <div class="task-form-actions">
              <button type="submit" class="btn-primary">
                æ·»åŠ ä»»åŠ¡
              </button>
            </div>
          </form>
          <!-- ä»»åŠ¡å¡ç‰‡å®¹å™¨ -->
          <div id="taskBoard" class="task-board">
            <p class="task-empty">
              ç›®å‰è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»ä¸Šæ–¹â€œåˆ·æ–°ä»»åŠ¡â€ä»åç«¯åŠ è½½æ•°æ®ï¼Œæˆ–è€…å…ˆæ·»åŠ ä¸€æ¡ä»»åŠ¡ã€‚
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ userIdï¼ˆç™»å½•æ—¶å†™å…¥ localStorageï¼‰
    function getCurrentUserId() {
      return localStorage.getItem("userId");
    }
    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ä¸ºå¡ç‰‡
    function renderTasks(tasks) {
      var board = document.getElementById("taskBoard");
      if (!board) return;
      board.innerHTML = "";
      if (!tasks || tasks.length === 0) {
        var empty = document.createElement("p");
        empty.className = "task-empty";
        empty.textContent = "æ²¡æœ‰ä»»åŠ¡ï¼Œè¯•è¯•æ·»åŠ ä¸€æ¡æˆ–ç‚¹å‡»â€œåˆ·æ–°ä»»åŠ¡â€ã€‚";
        board.appendChild(empty);
        return;
      }
      tasks.forEach(function (task) {
        var card = document.createElement("div");
        card.className = "task-card";
        var title = document.createElement("div");
        title.className = "task-title";
        title.textContent = task.something || "æœªå¡«å†™ä»»åŠ¡å†…å®¹";
        var meta = document.createElement("div");
        meta.className = "task-meta";
        var timeSpan = document.createElement("span");
        timeSpan.textContent = "æ—¥æœŸï¼š" + (task.time || "-");
        var placeSpan = document.createElement("span");
        placeSpan.textContent = "åœ°ç‚¹ï¼š" + (task.place || "-");
        var staffSpan = document.createElement("span");
        staffSpan.textContent = "è´Ÿè´£äººï¼š" + (task.staff || "-");
        meta.appendChild(timeSpan);
        meta.appendChild(placeSpan);
        meta.appendChild(staffSpan);
        var content = document.createElement("div");
        content.className = "task-content";
        content.textContent = task.something || "";
        var footer = document.createElement("div");
        footer.className = "task-footer";
        var urgencySpan = document.createElement("span");
        urgencySpan.className = "task-urgency";
        urgencySpan.textContent = "ç´§æ€¥ç¨‹åº¦ï¼š" + (task.urgency || 1);
        var deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "task-delete-btn";
        deleteBtn.textContent = "åˆ é™¤";
        deleteBtn.setAttribute("data-id", task.id);
        footer.appendChild(urgencySpan);
        footer.appendChild(deleteBtn);
        card.appendChild(title);
        card.appendChild(meta);
        // card.appendChild(content);
        card.appendChild(footer);
        board.appendChild(card);
      });
    }
    // è°ƒç”¨ /api/task/refresh è·å–ä»»åŠ¡åˆ—è¡¨
    async function refreshTasks() {
      var userId = getCurrentUserId();
      if (!userId) {
        alert("æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚");
        return;
      }
      try {
        var response = await fetch("/api/task/refresh", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            user_id: parseInt(userId, 10)
          })
        });
        if (!response.ok) {
          throw new Error("ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
        }
        var result = await response.json();
        if (result.success) {
          renderTasks(result.tasks  || []);
        } else {
          alert(result.message || "åˆ·æ–°ä»»åŠ¡å¤±è´¥");
        }
      } catch (err) {
        console.error(err);
        alert("åˆ·æ–°ä»»åŠ¡å¤±è´¥ï¼š" + err.message);
      }
    }
    // è°ƒç”¨ /api/task/add æ·»åŠ ä»»åŠ¡
    async function handleAddTask(event) {
      event.preventDefault();
      var userId = getCurrentUserId();
      if (!userId) {
        alert("æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚");
        return;
      }
      var timeInput = document.getElementById("taskTime");
      var placeInput = document.getElementById("taskPlace");
      var staffInput = document.getElementById("taskStaff");
      var urgencySelect = document.getElementById("taskUrgency");
      var somethingInput = document.getElementById("taskSomething");
      var payload = {
        user_id: parseInt(userId, 10),
        time: timeInput.value,
        place: placeInput.value,
        staff: staffInput.value,
        something: somethingInput.value,
        urgency: parseInt(urgencySelect.value || "1", 10)
      };
      if (!payload.time || !payload.something) {
        alert("æ—¥æœŸå’Œä»»åŠ¡å†…å®¹ä¸ºå¿…å¡«é¡¹ã€‚");
        return;
      }
      try {
        var response = await fetch("/api/task/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error("ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
        }
        var result = await response.json();
        if (result.success) {
          // æ¸…ç©ºè¡¨å•
          placeInput.value = "";
          staffInput.value = "";
          somethingInput.value = "";
          urgencySelect.value = "1";
          // é‡æ–°åˆ·æ–°åˆ—è¡¨
          await refreshTasks();
        } else {
          alert(result.message || "æ·»åŠ ä»»åŠ¡å¤±è´¥");
        }
      } catch (err) {
        console.error(err);
        alert("æ·»åŠ ä»»åŠ¡å¤±è´¥ï¼š" + err.message);
      }
    }
    // è°ƒç”¨ /api/task/delete åˆ é™¤ä»»åŠ¡
    async function deleteTaskById(id) {
      if (!id) return;
      if (!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡ä»»åŠ¡å—ï¼Ÿ")) return;
      try {
        var response = await fetch("/api/task/delete", {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ id: id })
        });
        if (!response.ok) {
          throw new Error("ç½‘ç»œé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š" + response.status);
        }
        var result = await response.json();
        if (result.success) {
          await refreshTasks();
        } else {
          alert(result.message || "åˆ é™¤ä»»åŠ¡å¤±è´¥");
        }
      } catch (err) {
        console.error(err);
        alert("åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼š" + err.message);
      }
    }
    // äº‹é¡¹çœ‹æ¿å†…äº‹ä»¶ç»‘å®šï¼ˆæŒ‰é’®ã€å¡ç‰‡åˆ é™¤ï¼‰
    function initTodoTaskEvents() {
      var refreshBtn = document.getElementById("btnRefreshTasks");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", function () {
          refreshTasks();
        });
      }
      var taskForm = document.getElementById("taskForm");
      if (taskForm) {
        taskForm.addEventListener("submit", handleAddTask);
      }
      var taskBoard = document.getElementById("taskBoard");
      if (taskBoard) {
        taskBoard.addEventListener("click", function (event) {
          var target = event.target;
          if (target.classList.contains("task-delete-btn")) {
            var id = target.getAttribute("data-id");
            deleteTaskById(id);
          }
        });
      }
    }
    // ========== å·¦ä¾§å¯¼èˆªï¼šé¡µé¢åˆ‡æ¢é€»è¾‘ ==========
    document.querySelectorAll(".nav-links li").forEach(function (item) {
      item.addEventListener("click", function () {
        var pageId = this.getAttribute("data-page");
        // ç§»é™¤æ‰€æœ‰ active
        document
          .querySelectorAll(".nav-links li")
          .forEach(function (li) {
            li.classList.remove("active");
          });
        document
          .querySelectorAll(".page")
          .forEach(function (p) {
            p.classList.remove("active");
          });
        // æ¿€æ´»å½“å‰é¡¹
        this.classList.add("active");
        var pageElement = document.getElementById("page-" + pageId);
        if (pageElement) {
          pageElement.classList.add("active");
        }
        // å¦‚æœåˆ‡æ¢åˆ°äº‹é¡¹çœ‹æ¿ï¼Œè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
        if (pageId === "todotask") {
          refreshTasks();
        }
      });
    });
    // é€€å‡ºç™»å½•
    function logout() {
      localStorage.removeItem("userId");
      localStorage.removeItem("teamName");
      window.location.href = "/"; // è·³å›ç™»å½•é¡µ
    }
    // é¡µé¢åŠ è½½æ—¶æ¢å¤ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºâ€œä¸ªäººä¸­å¿ƒâ€ï¼‰
    window.addEventListener("DOMContentLoaded", function () {
      var userId = localStorage.getItem("userId");
      var teamName = localStorage.getItem("teamName");
      // å¦‚æœä½ é¡µé¢é‡ŒçœŸçš„æœ‰å¯¹åº”å…ƒç´ ï¼Œå¯ä»¥è§£å¼€ä¸‹é¢çš„æ³¨é‡Šæ¥æ˜¾ç¤º
      // var userIdSpan = document.getElementById("displayUserId");
      // var teamNameSpan = document.getElementById("displayTeamName");
      if (userId && teamName) {
        // if (userIdSpan) userIdSpan.textContent = userId;
        // if (teamNameSpan) teamNameSpan.textContent = teamName;
      } else {
        // æœªç™»å½•åˆ™è·³è½¬å›é¦–é¡µ
        window.location.href = "/";
      }
      // åˆå§‹åŒ–äº‹é¡¹çœ‹æ¿çš„äº‹ä»¶ï¼ˆæŒ‰é’®ã€è¡¨å•ã€å¡ç‰‡åˆ é™¤ï¼‰
      initTodoTaskEvents();
      // åˆå§‹åŒ–ä¼šè®®åŠ©æ‰‹äº‹ä»¶
      initMeetingEvents();
    });

    // ========== ä¼šè®®åŠ©æ‰‹æ–°å¢JSä»£ç ï¼ˆè¿½åŠ åœ¨åŸæœ‰JSæ®µæœ«å°¾ï¼‰ ==========
    function initMeetingEvents() {
      // é€‰é¡¹å¡åˆ‡æ¢
      document.querySelectorAll(".meeting-tab").forEach(tab => {
        tab.addEventListener("click", function() {
          const tabType = this.getAttribute("data-tab");
          // åˆ‡æ¢é€‰é¡¹å¡æ¿€æ´»çŠ¶æ€
          document.querySelectorAll(".meeting-tab").forEach(t => t.classList.remove("active"));
          this.classList.add("active");
          // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
          document.querySelectorAll(".meeting-panel").forEach(panel => {
            panel.classList.remove("active");
            if (panel.id === `panel-${tabType}`) {
              panel.classList.add("active");
            }
          });
        });
      });

      // éŸ³é¢‘è½¬æ–‡å­—
      document.getElementById("btnAudioToText").addEventListener("click", async function() {
        const audioFile = document.getElementById("meetingAudio").files[0];
        const language = document.getElementById("audioLanguage").value;
        const transcriptBox = document.getElementById("transcriptBox");

        if (!audioFile) {
          alert("è¯·å…ˆä¸Šä¼ ä¼šè®®éŸ³é¢‘æ–‡ä»¶");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        this.textContent = "è½¬å†™ä¸­...";
        this.disabled = true;
        transcriptBox.textContent = "æ­£åœ¨å¤„ç†éŸ³é¢‘ï¼Œè¯·ç¨å€™...";

        try {
          const formData = new FormData();
          formData.append("audio", audioFile);
          formData.append("language", language);
          formData.append("user_id", getCurrentUserId());

          const response = await fetch("/api/meeting/audio-to-text", {
            method: "POST",
            body: formData
          });

          if (!response.ok) {
            throw new Error(`è½¬å†™å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
          }

          const result = await response.json();
          if (result.success) {
            transcriptBox.textContent = result.transcript || "æœªè¯†åˆ«åˆ°æœ‰æ•ˆå†…å®¹";
            // è‡ªåŠ¨å°†è½¬å†™ç»“æœå¤åˆ¶åˆ°æ‘˜è¦è¾“å…¥æ¡†
            document.getElementById("summarySource").value = result.transcript || "";
          } else {
            alert(`è½¬å†™å¤±è´¥ï¼š${result.message || "æœªçŸ¥é”™è¯¯"}`);
            transcriptBox.textContent = "";
          }
        } catch (err) {
          console.error("éŸ³é¢‘è½¬æ–‡å­—é”™è¯¯ï¼š", err);
          alert(`è½¬å†™å¤±è´¥ï¼š${err.message}`);
          transcriptBox.textContent = "";
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          this.textContent = "å¼€å§‹è½¬å†™";
          this.disabled = false;
        }
      });

      // ç”Ÿæˆä¼šè®®æ‘˜è¦
      document.getElementById("btnGenerateSummary").addEventListener("click", async function() {
        const sourceText = document.getElementById("summarySource").value.trim();
        const summaryType = document.getElementById("summaryType").value;
        const summaryLength = document.getElementById("summaryLength").value;
        const summaryBox = document.getElementById("summaryBox");

        if (!sourceText) {
          alert("è¯·è¾“å…¥ä¼šè®®åŸå§‹æ–‡æœ¬");
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        this.textContent = "ç”Ÿæˆä¸­...";
        this.disabled = true;
        summaryBox.textContent = "æ­£åœ¨ç”Ÿæˆæ‘˜è¦ï¼Œè¯·ç¨å€™...";

        try {
          const response = await fetch("/api/meeting/generate-summary", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              user_id: getCurrentUserId(),
              source_text: sourceText,
              summary_type: summaryType,
              summary_length: summaryLength
            })
          });

          if (!response.ok) {
            throw new Error(`ç”Ÿæˆå¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
          }

          const result = await response.json();
          if (result.success) {
            summaryBox.textContent = result.summary || "æ— æ³•ç”Ÿæˆæœ‰æ•ˆæ‘˜è¦";
          } else {
            alert(`ç”Ÿæˆå¤±è´¥ï¼š${result.message || "æœªçŸ¥é”™è¯¯"}`);
            summaryBox.textContent = "";
          }
        } catch (err) {
          console.error("ç”Ÿæˆä¼šè®®æ‘˜è¦é”™è¯¯ï¼š", err);
          alert(`ç”Ÿæˆå¤±è´¥ï¼š${err.message}`);
          summaryBox.textContent = "";
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          this.textContent = "ç”Ÿæˆæ‘˜è¦";
          this.disabled = false;
        }
      });

      // å¤åˆ¶è½¬å†™ç»“æœ
      document.getElementById("btnCopyTranscript").addEventListener("click", function() {
        const transcriptBox = document.getElementById("transcriptBox");
        if (!transcriptBox.textContent) {
          alert("æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹");
          return;
        }
        transcriptBox.select();
        document.execCommand("copy");
        alert("è½¬å†™ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
      });

      // å¤åˆ¶æ‘˜è¦ç»“æœ
      document.getElementById("btnCopySummary").addEventListener("click", function() {
        const summaryBox = document.getElementById("summaryBox");
        if (!summaryBox.textContent) {
          alert("æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹");
          return;
        }
        summaryBox.select();
        document.execCommand("copy");
        alert("ä¼šè®®æ‘˜è¦å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
      });

      // ä¸‹è½½è½¬å†™æ–‡æœ¬
      document.getElementById("btnDownloadTranscript").addEventListener("click", function() {
        const transcript = document.getElementById("transcriptBox").textContent;
        if (!transcript) {
          alert("æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹");
          return;
        }
        downloadFile(transcript, "ä¼šè®®è½¬å†™æ–‡æœ¬.txt", "text/plain");
      });

      // ä¸‹è½½æ‘˜è¦æŠ¥å‘Š
      document.getElementById("btnDownloadSummary").addEventListener("click", function() {
        const summary = document.getElementById("summaryBox").textContent;
        const summaryType = document.getElementById("summaryType").value;
        if (!summary) {
          alert("æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹");
          return;
        }
        const fileName = `${summaryType}-ä¼šè®®æ‘˜è¦.txt`;
        downloadFile(summary, fileName, "text/plain");
      });

      // æ¸…ç©ºä¼šè®®å†…å®¹
      document.getElementById("btnClearMeeting").addEventListener("click", function() {
        if (confirm("ç¡®è®¤è¦æ¸…ç©ºæ‰€æœ‰ä¼šè®®ç›¸å…³å†…å®¹å—ï¼Ÿ")) {
          document.getElementById("meetingAudio").value = "";
          document.getElementById("transcriptBox").textContent = "";
          document.getElementById("summarySource").value = "";
          document.getElementById("summaryBox").textContent = "";
        }
      });
    }

    // é€šç”¨æ–‡ä»¶ä¸‹è½½å‡½æ•°
    function downloadFile(content, fileName, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }
  </script>
</body>
</html>
